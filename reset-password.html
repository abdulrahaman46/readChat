<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Reset Password â€” SMA Welfare</title><link rel="stylesheet" href="styles.css"><link rel="stylesheet" href="libs/sweetalert2.min.css"/>
<link rel="stylesheet" href="libs/toastify.min.css"/>
</head><body>
<div class="center-card">
  <img src="../assets/logo.png" style="max-width:120px"/>
  <h3>Reset Admin Password</h3>
  <input id="email" placeholder="Admin email"/>
  <input id="secret" placeholder="Secret key"/>
  <input id="newpw" placeholder="New password" type="password"/>
  <input id="newpw2" placeholder="Repeat password" type="password"/>
  <button id="btnReset" class="btn-primary">Reset Password</button>
  <div id="msg" class="muted"></div>
</div>
<script>
const db = require('../../lib/db');
const bcrypt = require('bcryptjs');
document.getElementById('btnReset').addEventListener('click', () => {
  const email = document.getElementById('email').value.trim();
  const secret = document.getElementById('secret').value;
  const p1 = document.getElementById('newpw').value;
  const p2 = document.getElementById('newpw2').value;
  if (!email || !secret || !p1) return document.getElementById('msg').textContent='All fields required';
  if (p1 !== p2) return document.getElementById('msg').textContent='Passwords do not match';
  db.get('SELECT * FROM admins WHERE email=?', [email], (err, row) => {
    if (err || !row) return document.getElementById('msg').textContent='No such admin';
    if (!row.secret_key) return document.getElementById('msg').textContent='No secret key set. Admin must set it in Settings first.';
    const ok = bcrypt.compareSync(secret, row.secret_key);
    if (!ok) return document.getElementById('msg').textContent='Invalid secret key';
    const hash = bcrypt.hashSync(p1, 10);
    db.run('UPDATE admins SET password_hash=?, force_password_change=0 WHERE id=?', [hash, row.id], function(err2){
      if (err2) return document.getElementById('msg').textContent='Failed to reset';
      db.run('INSERT INTO audit_logs (admin_id,action,details,timestamp) VALUES (?,?,?,?)',
        [row.id, 'password_reset', JSON.stringify({by:'secret_key'}), Date.now()]);
      document.getElementById('msg').textContent='Password reset successfully. Please login.';
      setTimeout(()=> window.location='index.html', 1500);
    });
  });
});
</script>

<script>
function confirmAction(msg) {
  return confirm(msg || 'Are you sure?');
}
function toast(msg) {
  // simple toast
  const el = document.createElement('div');
  el.textContent = msg; el.style.position='fixed'; el.style.right='20px'; el.style.bottom='20px';
  el.style.background='#083'; el.style.color='#fff'; el.style.padding='10px 14px'; el.style.borderRadius='6px'; el.style.boxShadow='0 6px 18px rgba(0,0,0,0.12)';
  document.body.appendChild(el);
  setTimeout(()=> el.remove(), 3000);
}
</script>

<script src="libs/sweetalert2.min.js"></script>
<script src="libs/toastify.min.js"></script>
<script src="js/ui.js"></script>
</body></html>